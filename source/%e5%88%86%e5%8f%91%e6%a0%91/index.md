title: 分发树
date: 2011-07-23 11:40:21
---

**4.5 分发树**
RB分发树用来转发多播报文，理论上全网一棵树可以满足组播业务。为了组播负载分担和减少反向转发次数，TRILL允许计算多颗分发树。由Ingress对不同组选择使用不同分发树。

所有树都需要知道:
* 一共需要计算多少颗树
* 哪些树需要计算
* 这些树具体的数ID
* Ingress选择使用了那颗树

根优先级是16-bit，默认0x8000，数字越高优先级越高。

所有的RB都发布它能计算的最大树的数量，和它想让全网计算的最大树的数量。
k是全网root-priority最大的RB发布希望全网计算的最大树的数量。它不会比全网RB中能计算最小分发树数量还小。
如果RB没有指定根数列表，那么k就是全网RB中的前k个。
如果RB能发布能计算的最大数是0，那么按1计算，所以k默认值是1。

root-prioirty高的RB还有发布根树的列表，一共s个，其中的k个会被计算。如果s小于k个，那么依然需要计算k颗。剩下的从根数优先级高的开始补充到k。

有两个例外:
*  优先级为0的树不会选择成为根树，除非所有RB优先级都是0，那么选择最高优先级的一颗。所以至少保证有一颗。
* 当暂时列表中出现了两个或者多个相同根树时，保留优先级大的一个。

s=k, 发布和计算的相同
s=0, 将所有RB优先级排列，选择k颗颗
s&lt;k, 选择s颗，再补充道k颗

**4.5.1 分发树计算
**RB使用SPF算法计算分发树，并且树节点不能同时有两个父节点。在选择父节点时，不能单纯的选择ID小的。否则多棵树下路径不会分担。
当计算第j颗树时，对于节点N有p个父节点。需要选择第j mod p个父节点作为选择的父节点。

另外要注意并行链路, p2p或者抑制伪节点时，他们是有共同父节点的，即"P.0"

**4.5.2 多播检查
**1\. 邻居检查: 多播流量只能从建立邻居的接口进入。 <span style="color: #ff0000;"># RPF比邻居检查更严格，RPF只能检查接口，在广播网下只检查接口不够，所以还需要检查邻居MAC。</span>

2\. RPF检查: 对一个多播帧，基于其转发树和Ingress RB来检查的。
为了限制RPF检查量，RB2必须宣传对于一个多播帧使用了哪个根树x。RB3如果计算使用树x当Ingress RB是RB2时，流量需要从RB2的路径上流入。RB2需要发布选择使用了的j棵树。如果j棵树中的数在RB1的k颗中不存在，则忽略。
j棵树应该是包含在k棵树中的，j缺省值1，如果是0，那么可能选择k棵树中任意的。

3\. 并行链路检查:并行链路RB1-RB2之间的链路，指挥被RB1，RB2之间感知，所以只在这个设备之间检查。多播帧不能在负载分担链路上发多份。
P2P： 这时选择systemID大的邻居中CircuitID最大的。
抑制伪节点：选择伪节点ID最大的。

4\. 端口组检查: 多个端口在一个Link上时，有一个端口接收，其余丢弃。

**4.5.3 分发树剪枝
**可以对VLAN和组播组剪枝来消除冗余流量。对于组播组剪枝，需要IGMP , MLD协议映射IP组播与二层组播地址，并且要描述二层组播地址是IPv4/IPv6。

**<strong>4.5.4 组播分发优化
**</strong>网络中可以有一些RB进行了组播剪枝，一些没有。组播组相同。

**<strong><strong><strong>4.5.5 组播帧转发
**</strong></strong></strong>* 如果RB收到一个VLAN-x，并且TRILL头部表明使用了nickname1作为根树。
* 如果不是从邻居收到的，丢弃
* 如果是IGMP, MLD的通告报文，则封装后发给邻居nickname1树上的邻居。说明下游有VLAN-x的IPv4或IPv6路由。
* 如果是2层组播地址，从IP组播组映射的，但在IP组播组中找不到，那么当做广播。发给邻居。
* 不然，如果是纯2层组播地址，当成广播发给邻居。

数据帧对于VLAN forwarder解封装后每个Link都需要发。ESADI帧只需要forwarder处理就可以。

**<strong><strong><strong>
**</strong>
</strong>
 </strong>

&nbsp;

&nbsp;

&nbsp;

&nbsp;